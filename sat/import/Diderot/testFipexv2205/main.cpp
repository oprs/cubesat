#include "Fipex.h"
#include "SerialPort.h"
#include "Script.h"
#include "string.h"

int main(void)
{

	SystemInit();
	RCC_DeInit();
	//char sequenceCommand[]="~00010~17";
	char sequenceCommand[]=	{0x1C,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x20,0x20,0x0D,0x0A,	//Header
								0x7E,0x0F,0x00,0x0F,0x3C,0x00,0x20,0x0D,0x0A,		//OBC_SU_ON
								0x7E,0x00,0x00,0x00,0x01,0x00,0x20,0x0D,0x0A,
								0x7E,0x11,0x03,0x00,0x00,0x00,0x12,0x01,0x00,0x20,0x0D,0x0A,
								0x7E,0x0B,0x00,0x0B,0x01,0x00,0x20,0x0D,0x0A,
								0x7E,0x04,0x00,0x04,0x01,0x00,0x20,0x0D,0x0A,
								0x7E,0x20,0x00,0x20,0x01,0x00,0x20,0x0D,0x0A,
								0x7E,0x0A,0x00,0x0A,0x01,0x00,0x20,0x0D,0x0A,
								0x7E,0xF0,0x00,0xF0,0xFF,0xFF,0x20,0x0D,0x0A,		//OBC_SU_OFF
								0x7E,0xFF,0x01,0xFE,0x20,0x0D,0x0A};  //OBC_SU_END

	char standardCheckOut[]={0x7E,0x0F,0x00,0x0F,0x3C,0x00,0x20,0x0D,0x0A,		//OBC_SU_ON
								0x7E,0x00,0x00,0x00,0xFF,0xFF,0x20,0x0D,0x0A,	//SU_PING
								0x7E,0x20,0x00,0x20,0xFF,0xFF,0x20,0x0D,0x0A,	//SU_HK @NOW
								0x7E,0x11,0x03,0x02,0x1E,0x00,0x0E,0x01,0x00,0x20,0x0D,0x0A,	//SU_SP meas_time=30 @00:01
								0x7E,0x0C,0x00,0x0C,0xFF,0xFF,0x20,0x0D,0x0A,	//SU_SM @NOW
								0x7E,0x11,0x03,0x08,0x01,0x00,0x1B,0x3C,0x00,0x20,0x0D,0x0A,	//SU_SP stm_interval=1 @01:00
								0x7E,0x0A,0x00,0x0A,0xFF,0xFF,0x20,0x0D,0x0A,	//SU_STDBY @NOW
								0x7E,0x20,0x00,0x20,0xFF,0xFF,0x20,0x0D,0x0A,	//SU_HK @NOW
								0x7E,0x11,0x03,0x08,0x00,0x00,0x1A,0xFF,0xFF,0x20,0x0D,0x0A,	//SU_SP stm_interval=0 @NOW
								0x7E,0x11,0x03,0x04,0x02,0x00,0x14,0xFF,0xFF,0x20,0x0D,0x0A,	//SU_SP sensor=2 @NOW
								0x7E,0x0C,0x00,0x0C,0x1E,0x00,0x20,0x0D,0x0A,	//SU_SM @00:30
								0x7E,0x0A,0x00,0x0A,0xFF,0xFF,0x20,0x0D,0x0A,	//SU_STDBY @NOW
								0x7E,0x20,0x00,0x20,0xFF,0xFF,0x20,0x0D,0x0A,	//SU_HK @NOW
								0x7E,0xF0,0x00,0xF0,0xFF,0xFF,0x20,0x0D,0x0A,		//OBC_SU_OFF
								0x7E,0xFF,0x01,0xFE,0x20,0x0D,0x0A};  //OBC_SU_END};
	char testSU_DP[]={0x7E,0x0C,0x00,0x0C,0x1E,0x00,0x20,0x0D,0x0A,	//SU_SM @00:30
			0x7E,0x21,0x00,0x21,0x01,0x00,0x20,0x0D,0x0A};
	int scriptLenght=145;	//sequenceCommand=95
	CScript *script=new CScript(testSU_DP,18,binaire);
	CFIPEX *fipex= new CFIPEX(1);

	byte data[1]={0};
	byte ID=0;
	houseKeepingData hkData;
	byte commandId=0;
	byte taille=0;
	byte delay[2]={0};
	scienceDataPacket recupSDP;
	fipexError erreur;

	/*data[0]=0x04;
	data[1]=0x00;
	data[2]=0x01;

	fipex->setParameters(data,3);
	fipex->measure();
	fipex->getHousekeepingPacket(&hkData);*/
	//fipex->ping();
	/*fipex->getScienceDataPacket();
	fipex->getSuId(ID);
	fipex->ping();
	data[0]={0x05};
	fipex->calibrate(data,1);*/


	do
	{
		commandId=0;
		taille=0;
		delay[1]=delay[2]=0;


		if(script->getCommande(commandId,data,taille,delay))
		{
			switch (commandId)
			{
				case OBC_SU_ON:fipex->setOn();
					break;
				case SU_PING:fipex->ping(erreur);
					break;
				case SU_INIT:fipex->initialisation();
					break;
				case SU_ID:fipex->getSuId(ID);
					break;
				case SU_SP:fipex->setParameters(data,taille,erreur);
					break;
				case SU_HK:fipex->getHousekeepingPacket(&hkData);
					break;
				case SU_DP:fipex->getScienceDataPacket(&recupSDP);
					break;
				case SU_STDBY:fipex->setStandbyMode();
					break;
				case SU_SC:fipex->setHealthCheckMode();
					break;
				case SU_SM:fipex->measure();
					break;
				/*case SU_CAL:fipex->calibrate();
					break;*/
				case OBC_SU_OFF:fipex->setOff();
					break;
				default:;
			}
		}
	} while (commandId!=OBC_SU_END);


}
